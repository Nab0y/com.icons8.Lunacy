name: Update Lunacy Beta

on:
  schedule:
    # Run daily at 10:00 UTC
    - cron: '0 10 * * *'
  workflow_dispatch:

jobs:
  update:
    # Only run on the original flathub repository, not on forks
    if: github.repository == 'flathub/com.icons8.Lunacy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: beta

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests pyyaml

      - name: Check for beta updates and update manifest
        id: update
        run: |
          python3 << 'EOF'
          import requests
          import re
          import yaml
          import hashlib
          import os
          from datetime import datetime

          # Beta URLs
          BETA_X64_URL = "https://lcdn.icons8.com/setup/beta/Lunacy.deb"
          BETA_ARM_URL = "https://lcdn.icons8.com/setup/beta/Lunacy.ARM.deb"

          def get_deb_version(deb_url):
              """Download deb file and extract version using dpkg-deb"""
              try:
                  print(f"Downloading {deb_url} to check version...")
                  response = requests.get(deb_url, stream=True)
                  if response.status_code != 200:
                      print(f"Failed to download {deb_url}: {response.status_code}")
                      return None
                  
                  # Save to temporary file
                  with open('/tmp/beta_lunacy.deb', 'wb') as f:
                      f.write(response.content)
                  
                  # Get version using dpkg-deb
                  import subprocess
                  result = subprocess.run(['dpkg-deb', '-f', '/tmp/beta_lunacy.deb', 'Version'], 
                                        capture_output=True, text=True)
                  if result.returncode == 0:
                      version = result.stdout.strip()
                      print(f"Found version: {version}")
                      return version
                  else:
                      print(f"Failed to get version: {result.stderr}")
                      return None
              except Exception as e:
                  print(f"Error getting version from {deb_url}: {e}")
                  return None

          def get_remote_file_hash(url):
              """Get SHA256 hash of remote file without downloading fully"""
              print(f"Checking hash for {url}")
              response = requests.get(url, stream=True)
              if response.status_code != 200:
                  raise Exception(f"Failed to download {url}: {response.status_code}")
              
              sha256_hash = hashlib.sha256()
              for chunk in response.iter_content(chunk_size=8192):
                  sha256_hash.update(chunk)
              
              return sha256_hash.hexdigest()

          # Get current beta version
          current_version = get_deb_version(BETA_X64_URL)
          if not current_version:
              print("Could not get current beta version")
              exit(1)

          # Load current manifest
          with open('com.icons8.Lunacy.yml', 'r') as f:
              manifest = yaml.safe_load(f)

          # Find current versions in manifest  
          x64_source = None
          arm64_source = None
          for source in manifest['modules'][0]['sources']:
              if source.get('type') == 'file' and 'setup/beta/Lunacy' in source.get('url', ''):
                  if source.get('only-arches') == ['x86_64']:
                      x64_source = source
                  elif source.get('only-arches') == ['aarch64']:
                      arm64_source = source

          if not x64_source:
              print("Could not find x64 source in manifest")
              exit(1)

          # Extract version from current URL to compare
          current_url = x64_source['url']
          print(f"Current URL in manifest: {current_url}")

          # Check if we need to update (compare versions)
          # For now, we'll always update to ensure we have the latest beta
          print(f"Latest beta version: {current_version}")
          print("Checking for updates...")

          try:
              # Check if x64 beta file has changed
              current_x64_hash = x64_source.get('sha256', '')
              remote_x64_hash = get_remote_file_hash(BETA_X64_URL)
              
              print(f"Current x64 hash in manifest: {current_x64_hash}")
              print(f"Remote x64 hash: {remote_x64_hash}")
              
              x64_needs_update = current_x64_hash != remote_x64_hash
              arm64_needs_update = False
              
              # Check ARM64 beta if available
              if arm64_source:
                  try:
                      current_arm64_hash = arm64_source.get('sha256', '')
                      remote_arm64_hash = get_remote_file_hash(BETA_ARM_URL)
                      
                      print(f"Current ARM64 hash in manifest: {current_arm64_hash}")
                      print(f"Remote ARM64 hash: {remote_arm64_hash}")
                      
                      arm64_needs_update = current_arm64_hash != remote_arm64_hash
                  except Exception as e:
                      print(f"WARNING: Could not check ARM64 beta: {e}")
              
              # Update manifest only if files have changed
              if x64_needs_update or arm64_needs_update:
                  print("Files have changed, updating manifest...")
                  
                  if x64_needs_update:
                      # Update only hash for file sources (no size needed)
                      x64_source['sha256'] = remote_x64_hash
                      print(f"Updated x64: sha256={remote_x64_hash}")
                  
                  if arm64_needs_update and arm64_source:
                      # Update only hash for file sources (no size needed)
                      arm64_source['sha256'] = remote_arm64_hash
                      print(f"Updated ARM64: sha256={remote_arm64_hash}")
                  
                  # Write updated manifest
                  with open('com.icons8.Lunacy.yml', 'w') as f:
                      yaml.dump(manifest, f, default_flow_style=False, sort_keys=False, indent=2)
                  
                  print("SUCCESS: Updated manifest with new beta hashes")
                  manifest_updated = True
              else:
                  print("No changes detected - files are up to date")
                  manifest_updated = False

          except Exception as e:
              print(f"CRITICAL ERROR: Failed to check beta files: {e}")
              exit(1)

          # Update metainfo.xml with beta version
          def update_metainfo_beta(version):
              try:
                  import xml.etree.ElementTree as ET
                   
                  tree = ET.parse('com.icons8.Lunacy.metainfo.xml')
                  root = tree.getroot()
                  
                  releases = root.find('releases')
                  if releases is None:
                      return False
                  
                  # Check if this version already exists
                  version_exists = False
                  for release in releases.findall('release'):
                      if release.get('version') == version:
                          version_exists = True
                          break
                  
                  if not version_exists:
                      # Add new beta release
                      today = datetime.now().strftime('%Y-%m-%d')
                      new_release = ET.SubElement(releases, 'release')
                      new_release.set('version', version)
                      new_release.set('date', today)
                      
                      description = ET.SubElement(new_release, 'description')
                      p = ET.SubElement(description, 'p')
                      p.text = f"Beta release of Lunacy {version} with new features and improvements."
                      
                      ul = ET.SubElement(description, 'ul')
                      li1 = ET.SubElement(ul, 'li')
                      li1.text = "Latest beta version with cutting-edge features"
                      li2 = ET.SubElement(ul, 'li')
                      li2.text = "Performance improvements and bug fixes"
                      li3 = ET.SubElement(ul, 'li')
                      li3.text = "Bundled at build time - no download during installation"
                      
                      tree.write('com.icons8.Lunacy.metainfo.xml', encoding='UTF-8', xml_declaration=True)
                      return True
                  else:
                      print(f"Version {version} already exists in metainfo")
                      return False
              except Exception as e:
                  print(f"Error updating metainfo: {e}")
                  return False

          metainfo_updated = update_metainfo_beta(current_version)
          if metainfo_updated:
              print("SUCCESS: Updated metainfo.xml with new beta release")
          else:
              print("INFO: Metainfo already up to date")

          # Set output for next step
          files_updated = manifest_updated or metainfo_updated
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"updated={files_updated}\n")
              f.write(f"version={current_version}\n")
              f.write(f"manifest_updated={manifest_updated}\n")
              f.write(f"metainfo_updated={metainfo_updated}\n")

          print(f"SUCCESS: Beta update completed for version {current_version}")
          EOF

      - name: Create Pull Request
        if: steps.update.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: beta-update-${{ github.run_number }}
          base: beta
          commit-message: |
            Update Lunacy Beta to version ${{ steps.update.outputs.version }}

            - Version: ${{ steps.update.outputs.version }}
            - Manifest: ${{ steps.update.outputs.manifest_updated == 'true' && 'Updated' || 'No changes' }}
            - Metainfo: ${{ steps.update.outputs.metainfo_updated == 'true' && 'Updated' || 'No changes' }}

            Auto-generated by GitHub Actions.
          title: "🤖 Update Lunacy Beta to version ${{ steps.update.outputs.version }}"
          body: |
            ## 📦 Automated Beta Update

            **Version:** `${{ steps.update.outputs.version }}`

            ### Changes made:
            - **Manifest:** ${{ steps.update.outputs.manifest_updated == 'true' && '✅ Updated' || '⚪ No changes' }}
            - **Metainfo:** ${{ steps.update.outputs.metainfo_updated == 'true' && '✅ Updated' || '⚪ No changes' }}

            ### Details:
            This PR was automatically created by the scheduled beta update workflow.
            All file hashes have been verified and updated accordingly.

            **Auto-merge is enabled** - this PR will be automatically merged after all checks pass.

            ---
            *Generated by GitHub Actions run #${{ github.run_number }}*
          labels: |
            automated
            beta-update
          assignees: ${{ github.actor }}
          delete-branch: true
          add-paths: |
            com.icons8.Lunacy.yml
            com.icons8.Lunacy.metainfo.xml
        id: create-pr

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
            --auto --squash \
            --subject "🤖 Auto-merge: Update Lunacy Beta to ${{ steps.update.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}